<!DOCTYPE html>
<html lang="ru" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mouse & Keyboard Tester ‚Äî v0.2 (Vanilla JS)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; }
    html, body { height: 100%; }
    /* Prevent scrollbar flicker by ensuring consistent scrollbar gutter */
    html { scrollbar-gutter: stable; }
    /* Prevent text selection in test area */
    #test-area { -webkit-user-select: none; -moz-user-select: none; user-select: none; overscroll-behavior: none; touch-action: none; overflow: hidden; }
    
    /* Light theme styles */
    .light-theme {
      color-scheme: light;
    }
    .light-theme body {
      background-color: #f8fafc !important;
      color: #1e293b !important;
    }
    .light-theme .bg-slate-950 { background-color: #f8fafc !important; }
    .light-theme .bg-slate-900 { background-color: #ffffff !important; }
    .light-theme .bg-slate-800 { background-color: #f1f5f9 !important; }
    .light-theme .bg-slate-700 { background-color: #e2e8f0 !important; }
    .light-theme .border-slate-800 { border-color: #cbd5e1 !important; }
    .light-theme .border-slate-700 { border-color: #94a3b8 !important; }
    .light-theme .text-slate-100 { color: #1e293b !important; }
    .light-theme .text-slate-300 { color: #475569 !important; }
    .light-theme .text-slate-400 { color: #64748b !important; }
    .light-theme .text-slate-500 { color: #64748b !important; }
    .light-theme button:hover { background-color: #e2e8f0 !important; }
  </style>
</head>
<body class="min-h-full bg-slate-950 text-slate-100">
  <!-- Header -->
  <header class="border-b border-slate-800">
    <div class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between gap-4">
      <h1 class="text-xl sm:text-2xl font-semibold tracking-tight">Mouse & Keyboard Tester</h1>
      <div class="flex items-center gap-3">
        <label class="flex items-center gap-2 text-sm">
          <input id="toggle-enabled" type="checkbox" class="size-4 accent-emerald-500" checked />
          <span id="enabled-label">–¢–µ—Å—Ç –≤–∫–ª—é—á—ë–Ω</span>
        </label>
        <button id="btn-reset" class="rounded-xl px-3 py-2 bg-slate-800 hover:bg-slate-700 text-sm">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button id="btn-export" class="rounded-xl px-3 py-2 bg-slate-800 hover:bg-slate-700 text-sm">–≠–∫—Å–ø–æ—Ä—Ç TXT</button>
        <button id="btn-copy" class="rounded-xl px-3 py-2 bg-slate-800 hover:bg-slate-700 text-sm">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="btn-theme" class="rounded-xl px-3 py-2 bg-slate-800 hover:bg-slate-700 text-sm">üåô –°–≤–µ—Ç–ª–∞—è</button>
      </div>
    </div>
    <!-- Top Ad Slot -->
    <div class="mx-auto max-w-7xl px-4 pb-4">
      <div class="w-full min-h-16 sm:min-h-20 md:min-h-24 rounded-xl bg-slate-800/60 flex items-center justify-center text-slate-400 text-xs">
        –†–µ–∫–ª–∞–º–Ω—ã–π –±–∞–Ω–Ω–µ—Ä (728x90 / –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π)
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-7xl grid grid-cols-1 lg:grid-cols-12 gap-4 p-4">
    <!-- Controls -->
    <section class="lg:col-span-3 space-y-4">
      <div class="rounded-2xl bg-slate-900 border border-slate-800 p-4">
        <h2 class="text-lg font-semibold mb-3">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h2>
        <div class="space-y-4">
          <div>
            <label class="text-sm text-slate-300">–ü–æ—Ä–æ–≥ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ (–º—Å)</label>
            <input id="dbl-threshold" type="number" min="50" max="500" step="10" value="70" class="mt-1 w-full rounded-xl bg-slate-800 border border-slate-700 px-3 py-2" />
            <p class="text-xs text-slate-400 mt-1">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –∫–ª–∏–∫–∞–º–∏ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ: 150-250–º—Å.</p>
          </div>
          <div>
            <label class="text-sm text-slate-300">–û–∫–Ω–æ —Ä–µ–≤–µ—Ä—Å–∞ –∫–æ–ª–µ—Å–∞ (–º—Å)</label>
            <input id="reverse-window" type="number" min="20" max="200" step="5" value="80" class="mt-1 w-full rounded-xl bg-slate-800 border border-slate-700 px-3 py-2" />
            <p class="text-xs text-slate-400 mt-1">–ï—Å–ª–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—è–µ—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ —ç—Ç–æ–≥–æ –æ–∫–Ω–∞ ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ä–µ–≤–µ—Ä—Å.</p>
          </div>
        </div>
      </div>

      <div class="rounded-2xl bg-slate-900 border border-slate-800 p-4">
        <h2 class="text-lg font-semibold mb-3">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        <ul class="space-y-2 text-sm">
          <li class="flex items-center justify-between"><span>–î–∞–±–±–ª-–∫–ª–∏–∫–∏ LMB:</span><span id="dbl-lmb" class="font-mono">0</span></li>
          <li class="flex items-center justify-between"><span>–î–∞–±–±–ª-–∫–ª–∏–∫–∏ MMB:</span><span id="dbl-mmb" class="font-mono">0</span></li>
          <li class="flex items-center justify-between"><span>–î–∞–±–±–ª-–∫–ª–∏–∫–∏ RMB:</span><span id="dbl-rmb" class="font-mono">0</span></li>
          <li class="flex items-center justify-between"><span>–ö–æ–ª-–≤–æ —à–∞–≥–æ–≤ –∫–æ–ª–µ—Å–∞:</span><span id="wheel-total" class="font-mono">0</span></li>
          <li class="flex items-center justify-between"><span>–†–µ–≤–µ—Ä—Å—ã –∫–æ–ª–µ—Å–∞:</span><span id="wheel-rev" class="font-mono">0</span></li>
          <li class="flex items-center justify-between"><span>–î–æ–ª—è —Ä–µ–≤–µ—Ä—Å–æ–≤:</span><span id="wheel-rate" class="font-mono">0%</span></li>
        </ul>
      </div>

      <!-- Sidebar Ad Slot -->
      <div class="rounded-2xl bg-slate-900 border border-slate-800 p-4">
        <div class="w-full min-h-48 rounded-xl bg-slate-800/60 flex items-center justify-center text-slate-400 text-xs">
          –†–µ–∫–ª–∞–º–Ω—ã–π –±–ª–æ–∫ (300x250 / –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π)
        </div>
      </div>
    </section>

    <!-- Test Area -->
    <section class="lg:col-span-6 space-y-4">
      <div id="test-area" tabindex="0"
           class="rounded-2xl border border-slate-800 bg-slate-900 p-6 outline-none focus:ring-2 focus:ring-emerald-500 min-h-[360px] select-none relative">
        <h2 class="text-lg font-semibold mb-1">–ó–æ–Ω–∞ —Ç–µ—Å—Ç–∞ –º—ã—à–∏</h2>
        <p class="text-sm text-slate-400 mb-4">–ö–ª–∏–∫–∞–π—Ç–µ –õ–ö–ú/–°–ö–ú/–ü–ö–ú –∏ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–π—Ç–µ –∫–æ–ª–µ—Å–æ. –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –∏ –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –æ—Ç–∫–ª—é—á–µ–Ω—ã –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–π –∑–æ–Ω—ã.</p>

        <!-- Notification Area -->
        <div id="notification-area" class="absolute top-4 right-4 space-y-2 pointer-events-none z-10"></div>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div id="ind-lmb" class="rounded-2xl border p-4 flex items-center justify-between border-slate-800 bg-slate-900">
            <span class="font-medium">–õ–ö–ú</span>
            <span class="size-3 rounded-full bg-slate-700"></span>
          </div>
          <div id="ind-mmb" class="rounded-2xl border p-4 flex items-center justify-between border-slate-800 bg-slate-900">
            <span class="font-medium">–°–ö–ú</span>
            <span class="size-3 rounded-full bg-slate-700"></span>
          </div>
          <div id="ind-rmb" class="rounded-2xl border p-4 flex items-center justify-between border-slate-800 bg-slate-900">
            <span class="font-medium">–ü–ö–ú</span>
            <span class="size-3 rounded-full bg-slate-700"></span>
          </div>
        </div>

        <div class="mt-4 rounded-2xl border border-slate-800 bg-slate-900 p-4">
          <div class="flex items-center justify-between">
            <span id="wheel-label" class="font-medium">–ö–æ–ª–µ—Å–æ: –Ω–µ—Ç –¥–≤–∏–∂–µ–Ω–∏—è</span>
            <div class="flex items-center gap-2">
              <div id="arrow-up" class="px-3 py-1 rounded-xl border border-slate-800 bg-slate-900">‚Üë</div>
              <div id="arrow-down" class="px-3 py-1 rounded-xl border border-slate-800 bg-slate-900">‚Üì</div>
            </div>
          </div>
          <p class="text-xs text-slate-400 mt-2">–†–µ–≤–µ—Ä—Å—ã —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è, –µ—Å–ª–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—è–µ—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –æ–∫–Ω–∞.</p>
        </div>

        <div class="mt-6 text-xs text-slate-400">
          <p>–ü–æ–¥—Å–∫–∞–∑–∫–∏:</p>
          <ul class="list-disc ml-5 space-y-1">
            <li>–ü–ö–ú —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤–Ω—É—Ç—Ä–∏ –∑–æ–Ω—ã ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é —Ç—É—Ç –æ—Ç–∫–ª—é—á–µ–Ω–æ.</li>
            <li>–°–ö–ú –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –ø–æ–¥–∞–≤–ª–µ–Ω; —ç—Ç–æ –æ–∂–∏–¥–∞–µ–º–æ.</li>
            <li>–ü–æ–¥—Å—Ç—Ä–æ–π—Ç–µ –ø–æ—Ä–æ–≥ –¥–∞–±–±–ª-–∫–ª–∏–∫–∞ –ø–æ–¥ —Å–≤–æ—é –º—ã—à—å.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Logs -->
    <section class="lg:col-span-3 space-y-4">
      <div class="rounded-2xl bg-slate-900 border border-slate-800 p-4">
        <h2 class="text-lg font-semibold mb-3">–õ–æ–≥–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 1000)</h2>
        <div class="h-[420px] overflow-auto pr-2">
          <table class="w-full text-sm">
            <thead class="sticky top-0 bg-slate-900">
              <tr class="text-slate-400">
                <th class="text-left font-medium py-2">–í—Ä–µ–º—è</th>
                <th class="text-left font-medium py-2">–°–æ–±—ã—Ç–∏–µ</th>
                <th class="text-left font-medium py-2">–î–µ—Ç–∞–ª–∏</th>
              </tr>
            </thead>
            <tbody id="log-body">
              <tr><td class="py-2 text-slate-500" colspan="3">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π ‚Äî –Ω–∞—á–Ω–∏—Ç–µ —Ç–µ—Å—Ç.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <footer class="mx-auto max-w-7xl px-4 pb-8 text-xs text-slate-500">
    <p>v0.2 ‚Äî —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥-MVP –Ω–∞ —á–∏—Å—Ç–æ–º JS. –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: —Ç–µ—Å—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (ghosting, KRO, latency), –ø—Ä–µ—Å–µ—Ç—ã –∏ –æ–±—â–∏–π –æ—Ç—á—ë—Ç.</p>
  </footer>

  <script>
    // ------- State -------
    let enabled = true;
    let dblThresholdMs = 70;
    let reverseWindowMs = 80;
    let isDarkTheme = true;

    const logs = []; // newest first (limit 1000)
    const doubleCounts = { '–õ–ö–ú': 0, '–°–ö–ú': 0, '–ü–ö–ú': 0 };
    const wheelStats = { reversals: 0, total: 0 };

    const lastDown = { 0: 0, 1: 0, 2: 0 }; // per-button last mousedown time
    const lastWheel = { t: 0, sign: 0 };
    let wheelIdleTimer = null;

    // ------- Elements -------
    const elEnabled = document.getElementById('toggle-enabled');
    const elEnabledLabel = document.getElementById('enabled-label');
    const elDblThreshold = document.getElementById('dbl-threshold');
    const elRevWindow = document.getElementById('reverse-window');

    const elDblL = document.getElementById('dbl-lmb');
    const elDblM = document.getElementById('dbl-mmb');
    const elDblR = document.getElementById('dbl-rmb');
    const elWheelTotal = document.getElementById('wheel-total');
    const elWheelRev = document.getElementById('wheel-rev');
    const elWheelRate = document.getElementById('wheel-rate');

    const testArea = document.getElementById('test-area');
    const notificationArea = document.getElementById('notification-area');

    const indL = document.getElementById('ind-lmb');
    const indM = document.getElementById('ind-mmb');
    const indR = document.getElementById('ind-rmb');

    const wheelLabel = document.getElementById('wheel-label');
    const arrowUp = document.getElementById('arrow-up');
    const arrowDown = document.getElementById('arrow-down');

    const logBody = document.getElementById('log-body');

    const btnReset = document.getElementById('btn-reset');
    const btnExport = document.getElementById('btn-export');
    const btnCopy = document.getElementById('btn-copy');
    const btnTheme = document.getElementById('btn-theme');

    // ------- Utils -------
    const now = () => Date.now();
    const fmtTime = (ms) => new Date(ms).toLocaleTimeString('ru-RU', { hour12: false });

    function showNotification(message, type = 'default') {
      const notification = document.createElement('div');
      const bgColor = type === 'doubleclick' ? 'bg-red-600' : 
                     type === 'reversal' ? 'bg-orange-600' : 'bg-blue-600';
      
      notification.className = `${bgColor} text-white px-3 py-2 rounded-lg text-sm font-medium shadow-lg transform transition-all duration-300 opacity-0 translate-x-4`;
      notification.textContent = message;
      
      notificationArea.appendChild(notification);
      
      // –ó–≤—É–∫–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      playNotificationSound(type);
      
      // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
      setTimeout(() => {
        notification.classList.remove('opacity-0', 'translate-x-4');
      }, 10);
      
      // –£–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => {
        notification.classList.add('opacity-0', 'translate-x-4');
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 2000);
    }

    function playNotificationSound(type) {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // –†–∞–∑–Ω—ã–µ —á–∞—Å—Ç–æ—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π
        const frequency = type === 'doubleclick' ? 800 : type === 'reversal' ? 600 : 500;
        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
        oscillator.type = 'sine';
        
        // –ö–æ—Ä–æ—Ç–∫–∏–π –∑–≤—É–∫
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
      } catch (e) {
        // –ó–≤—É–∫ –Ω–µ –∫—Ä–∏—Ç–∏—á–µ–Ω, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
      }
    }

    function pushLog(item) {
      logs.unshift(item);
      if (logs.length > 1000) logs.pop();
      renderLogs();
    }

    function formatLogEvent(log) {
      let event = '';
      let details = '';
      let isSpecial = false; // –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∫—Ä–∞—Å–Ω—ã–º
      
      switch (log.type) {
        case 'click-down':
          event = log.details.button;
          details = '–ù–∞–∂–∞—Ç–∏–µ';
          break;
        case 'click-up':
          event = log.details.button;
          details = '–û—Ç–ø—É—Å–∫–∞–Ω–∏–µ';
          break;
        case 'double-click':
          event = log.details.button;
          details = `–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ (${log.details.deltaMs}–º—Å)`;
          isSpecial = true; // –≤—ã–¥–µ–ª—è–µ–º –¥–≤–æ–π–Ω—ã–µ –∫–ª–∏–∫–∏
          break;
        case 'wheel':
          event = '–ö–æ–ª–µ—Å–æ';
          details = log.details.dir === 'up' ? '–°–∫—Ä–æ–ª–ª –≤–≤–µ—Ä—Ö' : '–°–∫—Ä–æ–ª–ª –≤–Ω–∏–∑';
          break;
        case 'wheel-reversal':
          event = '–ö–æ–ª–µ—Å–æ';
          details = `–†–µ–≤–µ—Ä—Å: ${log.details.from === 'up' ? '–≤–≤–µ—Ä—Ö' : '–≤–Ω–∏–∑'} ‚Üí ${log.details.to === 'up' ? '–≤–≤–µ—Ä—Ö' : '–≤–Ω–∏–∑'} (${log.details.sinceMs}–º—Å)`;
          isSpecial = true; // –≤—ã–¥–µ–ª—è–µ–º —Ä–µ–≤–µ—Ä—Å—ã
          break;
        case 'info':
          event = '–°–∏—Å—Ç–µ–º–∞';
          details = log.details.message;
          break;
        default:
          event = log.type;
          details = JSON.stringify(log.details || {});
      }
      
      return { event, details, isSpecial };
    }

    function renderLogs() {
      if (logs.length === 0) {
        logBody.innerHTML = '<tr><td class="py-2 text-slate-500" colspan="3">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π ‚Äî –Ω–∞—á–Ω–∏—Ç–µ —Ç–µ—Å—Ç.</td></tr>';
        return;
      }
      const rows = logs.map((l) => {
        const { event, details, isSpecial } = formatLogEvent(l);
        const rowClass = isSpecial ? 'border-t border-slate-800/60 bg-red-900/20' : 'border-t border-slate-800/60';
        const textClass = isSpecial ? 'text-red-300' : 'text-slate-300';
        return `<tr class="${rowClass}">
          <td class="py-1 font-mono text-xs">${fmtTime(l.t)}</td>
          <td class="py-1 ${isSpecial ? 'text-red-400 font-semibold' : ''}">${event}</td>
          <td class="py-1 ${textClass}">${details}</td>
        </tr>`;
      }).join('');
      logBody.innerHTML = rows;
    }

    function updateStats() {
      elDblL.textContent = String(doubleCounts['–õ–ö–ú']);
      elDblM.textContent = String(doubleCounts['–°–ö–ú']);
      elDblR.textContent = String(doubleCounts['–ü–ö–ú']);
      elWheelTotal.textContent = String(wheelStats.total);
      elWheelRev.textContent = String(wheelStats.reversals);
      const rate = wheelStats.total ? (100 * wheelStats.reversals / wheelStats.total) : 0;
      elWheelRate.textContent = `${rate.toFixed(1)}%`;
    }

    function setIndicator(el, active) {
      el.classList.toggle('border-emerald-500', active);
      el.classList.toggle('bg-emerald-500/10', active);
      const dot = el.querySelector('span.size-3');
      if (dot) {
        dot.classList.toggle('bg-emerald-400', active);
        dot.classList.toggle('animate-pulse', active);
        dot.classList.toggle('bg-slate-700', !active);
      }
    }

    function setWheelUI(dir) {
      if (dir === 'idle') {
        wheelLabel.textContent = '–ö–æ–ª–µ—Å–æ: –Ω–µ—Ç –¥–≤–∏–∂–µ–Ω–∏—è';
        arrowUp.classList.remove('border-emerald-500','bg-emerald-500/10');
        arrowDown.classList.remove('border-emerald-500','bg-emerald-500/10');
        arrowUp.classList.add('border-slate-800','bg-slate-900');
        arrowDown.classList.add('border-slate-800','bg-slate-900');
      } else if (dir === 'up') {
        wheelLabel.textContent = '–ö–æ–ª–µ—Å–æ: –≤–≤–µ—Ä—Ö';
        arrowUp.classList.add('border-emerald-500','bg-emerald-500/10');
        arrowDown.classList.remove('border-emerald-500','bg-emerald-500/10');
        arrowUp.classList.remove('border-slate-800','bg-slate-900');
        arrowDown.classList.add('border-slate-800','bg-slate-900');
      } else {
        wheelLabel.textContent = '–ö–æ–ª–µ—Å–æ: –≤–Ω–∏–∑';
        arrowDown.classList.add('border-emerald-500','bg-emerald-500/10');
        arrowUp.classList.remove('border-emerald-500','bg-emerald-500/10');
        arrowDown.classList.remove('border-slate-800','bg-slate-900');
        arrowUp.classList.add('border-slate-800','bg-slate-900');
      }
    }

    function resetAll() {
      logs.length = 0;
      doubleCounts['–õ–ö–ú'] = doubleCounts['–°–ö–ú'] = doubleCounts['–ü–ö–ú'] = 0;
      wheelStats.reversals = 0; wheelStats.total = 0;
      renderLogs(); updateStats();
    }

    // ------- Event Handlers -------
    elEnabled.addEventListener('change', () => {
      enabled = elEnabled.checked;
      elEnabledLabel.textContent = enabled ? '–¢–µ—Å—Ç –≤–∫–ª—é—á—ë–Ω' : '–¢–µ—Å—Ç –≤—ã–∫–ª—é—á–µ–Ω';
    });

    elDblThreshold.addEventListener('input', () => {
      dblThresholdMs = parseInt(elDblThreshold.value || '0', 10);
    });

    elRevWindow.addEventListener('input', () => {
      reverseWindowMs = parseInt(elRevWindow.value || '0', 10);
    });

    btnReset.addEventListener('click', resetAll);

    btnExport.addEventListener('click', () => {
      // –°–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç
      const reversedLogs = [...logs].reverse();
      let textContent = `–û—Ç—á–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º—ã—à–∏\n`;
      textContent += `–î–∞—Ç–∞: ${new Date().toLocaleString('ru-RU')}\n`;
      textContent += `=====================================\n\n`;
      
      textContent += `–°–¢–ê–¢–ò–°–¢–ò–ö–ê:\n`;
      textContent += `- –î–≤–æ–π–Ω—ã–µ –∫–ª–∏–∫–∏ –õ–ö–ú: ${doubleCounts['–õ–ö–ú']}\n`;
      textContent += `- –î–≤–æ–π–Ω—ã–µ –∫–ª–∏–∫–∏ –°–ö–ú: ${doubleCounts['–°–ö–ú']}\n`;
      textContent += `- –î–≤–æ–π–Ω—ã–µ –∫–ª–∏–∫–∏ –ü–ö–ú: ${doubleCounts['–ü–ö–ú']}\n`;
      textContent += `- –®–∞–≥–æ–≤ –∫–æ–ª–µ—Å–∞: ${wheelStats.total}\n`;
      textContent += `- –†–µ–≤–µ—Ä—Å—ã –∫–æ–ª–µ—Å–∞: ${wheelStats.reversals}\n`;
      const rate = wheelStats.total ? (100 * wheelStats.reversals / wheelStats.total) : 0;
      textContent += `- –î–æ–ª—è —Ä–µ–≤–µ—Ä—Å–æ–≤: ${rate.toFixed(1)}%\n\n`;
      
      textContent += `–õ–û–ì–ò –°–û–ë–´–¢–ò–ô:\n`;
      textContent += `–í—Ä–µ–º—è\t\t–°–æ–±—ã—Ç–∏–µ\t\t–î–µ—Ç–∞–ª–∏\n`;
      textContent += `-----------------------------------------------\n`;
      
      reversedLogs.forEach(log => {
        const { event, details } = formatLogEvent(log);
        textContent += `${fmtTime(log.t)}\t\t${event}\t\t${details}\n`;
      });
      
      const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `mouse_test_${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    });

    btnCopy.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(JSON.stringify([...logs].reverse(), null, 2));
        pushLog({ t: now(), type: 'info', details: { message: 'Logs copied to clipboard' } });
      } catch (e) {
        pushLog({ t: now(), type: 'info', details: { message: 'Clipboard copy failed' } });
      }
    });

    btnTheme.addEventListener('click', () => {
      isDarkTheme = !isDarkTheme;
      if (isDarkTheme) {
        document.documentElement.classList.remove('light-theme');
        btnTheme.textContent = 'üåô –°–≤–µ—Ç–ª–∞—è';
      } else {
        document.documentElement.classList.add('light-theme');
        btnTheme.textContent = '‚òÄÔ∏è –¢–µ–º–Ω–∞—è';
      }
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –≤ localStorage
      localStorage.setItem('mouseTestTheme', isDarkTheme ? 'dark' : 'light');
    });

    function buttonLabel(button) {
      return button === 0 ? '–õ–ö–ú' : button === 1 ? '–°–ö–ú' : '–ü–ö–ú';
    }

    function onMouseDown(e) {
      if (!enabled) return;
      const t = now();
      const btn = e.button;

      // Indicators
      if (btn === 0) setIndicator(indL, true);
      if (btn === 1) setIndicator(indM, true);
      if (btn === 2) setIndicator(indR, true);

      // prevent default for RMB/MMB to keep test UX clean
      if (btn !== 0) e.preventDefault();

      const prev = lastDown[btn] || 0;
      const delta = t - prev;
      if (prev && delta <= dblThresholdMs) {
        const label = buttonLabel(btn);
        doubleCounts[label]++;
        pushLog({ t, type: 'double-click', details: { button: label, deltaMs: delta } });
        showNotification(`–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ ${label}!`, 'doubleclick');
        updateStats();
      } else {
        pushLog({ t, type: 'click-down', details: { button: buttonLabel(btn) } });
      }
      lastDown[btn] = t;
    }

    function onMouseUp(e) {
      if (!enabled) return;
      const btn = e.button;
      const t = now();
      if (btn === 0) setIndicator(indL, false);
      if (btn === 1) setIndicator(indM, false);
      if (btn === 2) setIndicator(indR, false);
      pushLog({ t, type: 'click-up', details: { button: buttonLabel(btn) } });
    }

    function onContextMenu(e) {
      e.preventDefault();
    }

    function onWheel(e) {
      // prevent page scroll while inside test area
      e.preventDefault();
      e.stopPropagation();
      if (!enabled) return;
      const t = now();
      const sign = Math.sign(e.deltaY); // >0 = down, <0 = up
      const dir = sign > 0 ? 'down' : sign < 0 ? 'up' : 'idle';

      if (sign !== 0) {
        wheelStats.total++;
        updateStats();
      }

      const last = lastWheel;
      const since = t - last.t;
      if (last.sign !== 0 && sign !== 0 && sign !== last.sign && since <= reverseWindowMs) {
        wheelStats.reversals++;
        pushLog({ t, type: 'wheel-reversal', details: { sinceMs: since, from: last.sign > 0 ? 'down' : 'up', to: dir, deltaY: e.deltaY } });
        showNotification(`–†–µ–≤–µ—Ä—Å –∫–æ–ª–µ—Å–∞! (${since}–º—Å)`, 'reversal');
        updateStats();
      } else if (sign !== 0) {
        pushLog({ t, type: 'wheel', details: { dir, deltaY: e.deltaY } });
      }

      lastWheel.t = t; lastWheel.sign = sign;
      setWheelUI(dir);

      if (wheelIdleTimer) clearTimeout(wheelIdleTimer);
      wheelIdleTimer = setTimeout(() => setWheelUI('idle'), 400);
    }

    // Attach listeners to test area only
    testArea.addEventListener('mousedown', onMouseDown);
    testArea.addEventListener('mouseup', onMouseUp);
    testArea.addEventListener('contextmenu', onContextMenu);
    // Important: passive:false so we can preventDefault() and stop page scroll
    testArea.addEventListener('wheel', onWheel, { passive: false });
    // Prevent touchpad/gesture scroll on touch devices within test area
    testArea.addEventListener('touchmove', (e) => { e.preventDefault(); }, { passive: false });

    // Track pointer/touch presence inside the test area
    let cursorInside = false;
    
    const enter = () => { 
      cursorInside = true; 
      testArea.focus(); 
    };
    const leave = () => { 
      cursorInside = false; 
    };

    testArea.addEventListener('pointerenter', enter);
    testArea.addEventListener('pointerleave', leave);
    testArea.addEventListener('mouseenter', enter);
    testArea.addEventListener('mouseleave', leave);
    testArea.addEventListener('touchstart', () => { cursorInside = true; }, { passive: false });
    testArea.addEventListener('touchend', () => { cursorInside = false; }, { passive: true });
    testArea.addEventListener('touchcancel', () => { cursorInside = false; }, { passive: true });

    // Global wheel blocker ‚Äî only prevent page scroll outside test area
    window.addEventListener('wheel', (e) => {
      // If the event originates from within the test area, let it be handled locally
      if (testArea.contains(e.target)) {
        return; // Let the testArea wheel handler deal with it
      }
      // Otherwise, prevent page scroll
      e.preventDefault();
    }, { passive: false });

    // Block keyboard-based scrolling while focus is in test area
    const scrollKeys = new Set([' ', 'Spacebar', 'ArrowUp', 'ArrowDown', 'PageUp', 'PageDown', 'Home', 'End']);
    testArea.addEventListener('keydown', (e) => {
      if (scrollKeys.has(e.key)) { e.preventDefault(); }
    });

    // Accessibility: focus test area on load for immediate testing
    window.addEventListener('load', () => { 
      testArea.focus(); 
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã –∏–∑ localStorage
      const savedTheme = localStorage.getItem('mouseTestTheme');
      if (savedTheme === 'light') {
        isDarkTheme = false;
        document.documentElement.classList.add('light-theme');
        btnTheme.textContent = '‚òÄÔ∏è –¢–µ–º–Ω–∞—è';
      }
    });
  </script>
</body>
</html>